<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Cadastro - OrganizaÃ§Ã£o de Tarefas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/theme.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2em;
        }

        .register-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 2em;
            width: 100%;
            max-width: 500px;
        }

        .logo {
            text-align: center;
            margin-bottom: 2em;
        }

        .logo h1 {
            color: #333;
            font-weight: 700;
            margin-bottom: 0.5em;
        }

        .logo p {
            color: #666;
            margin-bottom: 0;
        }

        .btn-register {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-register:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-login {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-login:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .password-strength {
            height: 5px;
            border-radius: 5px;
            margin-top: 5px;
            transition: all 0.3s ease;
        }

        .strength-weak {
            background-color: #dc3545;
            width: 25%;
        }

        .strength-medium {
            background-color: #ffc107;
            width: 50%;
        }

        .strength-strong {
            background-color: #28a745;
            width: 100%;
        }

        .login-link {
            text-align: center;
            margin-top: 1.5em;
            padding-top: 1.5em;
            border-top: 1px solid #dee2e6;
        }

        .success-animation {
            animation: successPulse 2s ease-in-out;
        }

        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px;
            transition: all 0.3s ease;
        }

        .password-toggle:hover {
            transform: translateY(-50%) scale(1.1);
        }

        .password-input-container {
            position: relative;
        }

        .password-input-container .form-control {
            padding-right: 50px;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>

<body>
    <button id="themeToggle" class="theme-toggle">
        <span class="sun">ðŸŒž</span>
        <span class="moon">ðŸŒ›</span>
    </button>

    <div class="register-container">
        <div class="logo">
            <h1>ðŸ“Š OrganizaÃ§Ã£o de Tarefas</h1>
            <p>Crie sua conta para comeÃ§ar</p>
        </div>

        <!-- FormulÃ¡rio de Cadastro -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="txtNome" class="form-label">Nome Completo *</label>
                <input type="text" id="txtNome" class="form-control" placeholder="Seu nome completo" />
                <div class="form-text">Como vocÃª gostaria de ser chamado</div>
            </div>

            <div class="col-md-6 mb-3">
                <label for="txtEmail" class="form-label">Email *</label>
                <input type="email" id="txtEmail" class="form-control" placeholder="seu@email.com" />
                <div class="form-text">Seu melhor email</div>
            </div>
        </div>

        <div class="mb-3">
            <label for="txtEmpresa" class="form-label">Empresa (Opcional)</label>
            <input type="text" id="txtEmpresa" class="form-control" placeholder="Nome da sua empresa" />
            <div class="form-text">Deixe em branco se for uso pessoal</div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="txtSenha" class="form-label">Senha *</label>
                <div class="password-input-container">
                    <input type="password" id="txtSenha" class="form-control" placeholder="Crie uma senha" />
                    <button type="button" class="password-toggle" id="toggleSenha">ðŸ™ˆ</button>
                </div>
                <div id="passwordStrength" class="password-strength"></div>
                <div class="form-text">MÃ­nimo 6 caracteres</div>
            </div>

            <div class="col-md-6 mb-3">
                <label for="txtConfirmarSenha" class="form-label">Confirmar Senha *</label>
                <div class="password-input-container">
                    <input type="password" id="txtConfirmarSenha" class="form-control" placeholder="Repita a senha" />
                    <button type="button" class="password-toggle" id="toggleConfirmarSenha">ðŸ™ˆ</button>
                </div>
                <div class="form-text">As senhas devem ser iguais</div>
            </div>
        </div>

        <div class="mb-3 form-check">
            <input type="checkbox" id="checkTermos" class="form-check-input" />
            <label for="checkTermos" class="form-check-label terms-text">
                Concordo com os <a href="#" class="text-decoration-none">Termos de Uso</a> e 
                <a href="#" class="text-decoration-none">PolÃ­tica de Privacidade</a> *
            </label>
        </div>

        <!-- BotÃ£o de Cadastro -->
        <div class="mb-3">
            <button id="btnRegister" class="btn btn-register w-100">Criar Conta</button>
        </div>

        <!-- Link para Login -->
        <div class="login-link">
            <p class="text-muted mb-2">JÃ¡ tem uma conta?</p>
            <button id="btnGoToLogin" class="btn btn-login w-100">Fazer Login</button>
        </div>

        <!-- Mensagens de resposta -->
        <div id="divResposta" class="alert" style="display: none;"></div>

        <div class="text-center mt-3">
            <small class="text-muted">
                Sistema de Gerenciamento de Projetos v1.0
            </small>
        </div>
    </div>

    <!-- Importar o theme.js -->
    <script src="js/theme.js"></script>

    <script type="module">
        import ApiService from './ApiService.js';

        // ReferÃªncias para elementos do DOM
        const txtNome = document.getElementById("txtNome");
        const txtEmail = document.getElementById("txtEmail");
        const txtEmpresa = document.getElementById("txtEmpresa");
        const txtSenha = document.getElementById("txtSenha");
        const txtConfirmarSenha = document.getElementById("txtConfirmarSenha");
        const toggleSenha = document.getElementById("toggleSenha");
        const toggleConfirmarSenha = document.getElementById("toggleConfirmarSenha");
        const checkTermos = document.getElementById("checkTermos");
        const btnRegister = document.getElementById("btnRegister");
        const btnGoToLogin = document.getElementById("btnGoToLogin");
        const divResposta = document.getElementById("divResposta");
        const passwordStrength = document.getElementById("passwordStrength");

        // ======================== TOGGLE DE SENHA ========================
        function toggleVisibilidadeSenha(input, botao) {
            const tipoAtual = input.type;
            if (tipoAtual === 'password') {
                input.type = 'text';
                botao.textContent = 'ðŸµ';
            } else {
                input.type = 'password';
                botao.textContent = 'ðŸ™ˆ';
            }
        }

        // ======================== VERIFICAÃ‡ÃƒO DE SENHA ========================
        function avaliarForcaSenha(senha) {
            if (!senha) {
                passwordStrength.className = 'password-strength';
                passwordStrength.style.width = '0%';
                return;
            }

            let forca = 0;
            
            // Comprimento mÃ­nimo
            if (senha.length >= 6) forca += 25;
            if (senha.length >= 8) forca += 15;
            
            // Caracteres diversos
            if (/[a-z]/.test(senha)) forca += 15;
            if (/[A-Z]/.test(senha)) forca += 15;
            if (/[0-9]/.test(senha)) forca += 15;
            if (/[^A-Za-z0-9]/.test(senha)) forca += 15;

            // Atualizar visual
            if (forca < 50) {
                passwordStrength.className = 'password-strength strength-weak';
                passwordStrength.style.width = '25%';
            } else if (forca < 75) {
                passwordStrength.className = 'password-strength strength-medium';
                passwordStrength.style.width = '50%';
            } else {
                passwordStrength.className = 'password-strength strength-strong';
                passwordStrength.style.width = '100%';
            }
        }

        // âœ… CORREÃ‡ÃƒO: Avaliar forÃ§a da senha em tempo real
        txtSenha.addEventListener("input", function() {
            avaliarForcaSenha(this.value);
        });

        // TambÃ©m avaliar quando o campo de confirmaÃ§Ã£o for modificado
        txtConfirmarSenha.addEventListener("input", function() {
            if (this.value === txtSenha.value && this.value.length > 0) {
                avaliarForcaSenha(this.value);
            }
        });

        // ======================== FUNÃ‡Ã•ES PRINCIPAIS ========================
        function showMessage(message, type) {
            divResposta.textContent = message;
            divResposta.className = `alert alert-${type}`;
            divResposta.style.display = 'block';
            
            if (type === 'success') {
                divResposta.classList.add('success-animation');
            }

            divResposta.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function fazerLoginAutomatico(dadosUsuario) {
            console.log("ðŸ” Fazendo login automÃ¡tico...", dadosUsuario);
            
            // âœ… CORREÃ‡ÃƒO MELHORADA: Salvar dados de forma consistente
            if (dadosUsuario.token) {
                localStorage.setItem("token", dadosUsuario.token);
            }
            
            // Salvar userData de forma padronizada
            const userData = {
                usuario: dadosUsuario.usuario || dadosUsuario,
                token: dadosUsuario.token
            };
            
            localStorage.setItem("userData", JSON.stringify(userData));
            
            console.log("âœ… Login automÃ¡tico realizado com sucesso!", userData);
            
            // Redirecionar para dashboard
            setTimeout(() => {
                window.location.href = "dashboard.html";
            }, 1500);
        }

        function validarFormulario() {
            if (txtNome.value.trim() === "") {
                showMessage("Nome completo Ã© obrigatÃ³rio", "warning");
                txtNome.focus();
                return false;
            }

            if (txtNome.value.trim().length < 2) {
                showMessage("Nome deve ter pelo menos 2 caracteres", "warning");
                txtNome.focus();
                return false;
            }

            if (txtEmail.value.trim() === "") {
                showMessage("Email Ã© obrigatÃ³rio", "warning");
                txtEmail.focus();
                return false;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(txtEmail.value)) {
                showMessage("Formato de email invÃ¡lido", "warning");
                txtEmail.focus();
                return false;
            }

            if (txtSenha.value.trim() === "") {
                showMessage("Senha Ã© obrigatÃ³ria", "warning");
                txtSenha.focus();
                return false;
            }

            if (txtSenha.value.length < 6) {
                showMessage("A senha deve ter pelo menos 6 caracteres", "warning");
                txtSenha.focus();
                return false;
            }

            if (txtConfirmarSenha.value.trim() === "") {
                showMessage("ConfirmaÃ§Ã£o de senha Ã© obrigatÃ³ria", "warning");
                txtConfirmarSenha.focus();
                return false;
            }

            if (txtSenha.value !== txtConfirmarSenha.value) {
                showMessage("As senhas nÃ£o coincidem", "warning");
                txtConfirmarSenha.focus();
                txtConfirmarSenha.select();
                return false;
            }

            if (!checkTermos.checked) {
                showMessage("VocÃª deve aceitar os termos de uso para continuar", "warning");
                checkTermos.focus();
                return false;
            }

            return true;
        }

        async function realizarCadastro() {
            if (!validarFormulario()) {
                return;
            }

            btnRegister.disabled = true;
            btnRegister.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Criando conta...';

            try {
                const dadosCadastro = {
                    "usuario": {
                        "nome": txtNome.value.trim(),
                        "email": txtEmail.value.trim(),
                        "senha": txtSenha.value.trim(),
                        "empresa": txtEmpresa.value.trim() || null
                    }
                };

                console.log("ðŸ“ Enviando requisiÃ§Ã£o de cadastro...", dadosCadastro);

                const resposta = await api.post("/api/usuario/", dadosCadastro);
                console.log("ðŸ“¨ Resposta completa da API:", resposta);

                if (resposta && resposta.success) {
                    console.log('âœ… Cadastro realizado com sucesso:', resposta);
                    
                    // âœ… CORREÃ‡ÃƒO: VerificaÃ§Ã£o mais robusta do token
                    const temToken = resposta.data?.token || resposta.token;
                    const temUsuario = resposta.data?.usuario || resposta.usuario;
                    
                    if (temToken && temUsuario) {
                        showMessage("ðŸŽ‰ Conta criada com sucesso! Fazendo login automÃ¡tico...", "success");
                        fazerLoginAutomatico(resposta.data || resposta);
                    } else {
                        // Se nÃ£o veio token, tentar fazer login automaticamente
                        showMessage("âœ… Conta criada! Tentando login automÃ¡tico...", "success");
                        
                        try {
                            const dadosLogin = {
                                "usuario": {
                                    "email": txtEmail.value.trim(),
                                    "senha": txtSenha.value.trim()
                                }
                            };
                            
                            const loginResposta = await api.post("/api/usuario/login", dadosLogin);
                            
                            if (loginResposta && loginResposta.success && loginResposta.data?.token) {
                                showMessage("ðŸŽ‰ Login automÃ¡tico realizado! Redirecionando...", "success");
                                fazerLoginAutomatico(loginResposta.data);
                            } else {
                                throw new Error("Login automÃ¡tico falhou");
                            }
                            
                        } catch (loginError) {
                            console.log("âš ï¸ Login automÃ¡tico falhou, redirecionando para login manual", loginError);
                            showMessage("âœ… Conta criada! FaÃ§a login para continuar.", "success");
                            
                            // Limpar formulÃ¡rio
                            txtNome.value = '';
                            txtEmail.value = '';
                            txtEmpresa.value = '';
                            txtSenha.value = '';
                            txtConfirmarSenha.value = '';
                            checkTermos.checked = false;
                            
                            // Redirecionar para login
                            setTimeout(() => {
                                window.location.href = "login.html";
                            }, 3000);
                        }
                    }

                } else {
                    const errorMessage = resposta.error?.message || "Erro ao criar conta. Tente novamente.";
                    showMessage(errorMessage, "danger");
                }

            } catch (error) {
                console.error("âŒ Erro no cadastro:", error);
                
                if (error.message?.includes('Failed to fetch')) {
                    showMessage("Erro de conexÃ£o. Verifique se o servidor Flask estÃ¡ rodando.", "danger");
                } else if (error.message?.includes('409') || error.message?.includes('Email jÃ¡ cadastrado')) {
                    showMessage("Este email jÃ¡ estÃ¡ cadastrado no sistema.", "warning");
                    txtEmail.focus();
                    txtEmail.select();
                } else {
                    showMessage("Erro ao criar conta. Tente novamente.", "danger");
                }
            } finally {
                btnRegister.disabled = false;
                btnRegister.textContent = "Criar Conta";
            }
        }

        // ======================== EVENT LISTENERS ========================
        btnRegister.addEventListener("click", realizarCadastro);
        btnGoToLogin.addEventListener("click", () => {
            window.location.href = "login.html";
        });

        toggleSenha.addEventListener("click", () => {
            toggleVisibilidadeSenha(txtSenha, toggleSenha);
        });

        toggleConfirmarSenha.addEventListener("click", () => {
            toggleVisibilidadeSenha(txtConfirmarSenha, toggleConfirmarSenha);
        });

        txtConfirmarSenha.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                realizarCadastro();
            }
        });

        // ======================== INICIALIZAÃ‡ÃƒO ========================
        // Verificar se jÃ¡ estÃ¡ logado
        const userData = localStorage.getItem("userData");
        if (userData) {
            window.location.href = "dashboard.html";
        }

        const api = new ApiService(null, "http://localhost:5000");
        txtNome.focus();

        console.log("ðŸš€ PÃ¡gina de cadastro carregada!");
    </script>
</body>
</html>